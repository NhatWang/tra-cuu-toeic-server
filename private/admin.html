<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quáº£n lÃ½ TOEIC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url("images/POSTER.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      backdrop-filter: blur(3px);
      z-index: 0;
    }
    .tabs { display: flex; background: #007bff; z-index: 9999; }
    .tab { flex: 1; padding: 14px; text-align: center; color: white; cursor: pointer; font-weight: bold; }
    .tab.active { background: #0056b3; }
    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    h2 { text-align: center; font-size: 28px; margin-bottom: 10px; }
    .search-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-bottom: 20px; }
    input[type="text"], select {
      padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; min-width: 250px;
    }
    #summary { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
    table { width: 100%; border-collapse: collapse; font-size: 16px; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .actions { text-align: center; margin-top: 24px; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .btn { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn:hover { background: #218838; }
    .hidden { display: none; }
    #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; }
    .toast {
      background-color: #28a745; color: white; padding: 14px 20px; margin-top: 12px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 16px; min-width: 220px;
      animation: slideInRight 0.5s ease forwards; position: relative; overflow: hidden;
    }
    .toast.exit { animation: slideOutRight 0.5s ease forwards; }
    .toast.error { background-color: #dc3545; }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dangky')">ğŸ“‹ ÄÄƒng kÃ½ báº£n cá»©ng</div>
    <div class="tab" onclick="switchTab('phuckhao')">ğŸ“© PhÃºc kháº£o</div>
  </div>

  <div class="container">
    <!-- Section ÄÄƒng kÃ½ -->
    <div id="section-dangky">
      <h2>DANH SÃCH THÃ SINH ÄÄ‚NG KÃ Báº¢N Cá»¨NG</h2>
      <div id="summary">Äang táº£i...</div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="TÃ¬m theo há» tÃªn / MSSV / lá»›p..." />
        <select id="filterLop"><option value="">-- Lá»c theo lá»›p --</option></select>
        <select id="filterStatus">
          <option value="">-- Lá»c tráº¡ng thÃ¡i --</option>
          <option value="dang_xu_ly">â³ Äang xá»­ lÃ½</option>
          <option value="cho_ky">ğŸ–‹ Chá» kÃ½</option>
          <option value="da_ky">âœ… ÄÃ£ kÃ½</option>
          <option value="dang_van_chuyen">ğŸšš Äang váº­n chuyá»ƒn</option>
          <option value="san_sang_nhan">ğŸ“¦ Sáºµn sÃ ng nháº­n</option>
          <option value="da_nhan">ğŸ“¬ ÄÃ£ nháº­n</option>
        </select>
      </div>
      <div id="adminTable">Loading...</div>
      <div class="actions">
        <button class="btn" onclick="exportToExcel()">ğŸ“¤ Xuáº¥t Excel</button>
        <button class="btn" onclick="window.print()">ğŸ–¨ï¸ In danh sÃ¡ch</button>
      </div>
    </div>

    <!-- Section PhÃºc kháº£o -->
    <div id="section-phuckhao" class="hidden">
      <h2>DANH SÃCH YÃŠU Cáº¦U PHÃšC KHáº¢O</h2>
      <div id="phucKhaoTable">Loading...</div>
    </div>
  </div>

  <script>
    dayjs.extend(dayjs_plugin_relativeTime);
    // Tham chiáº¿u DOM an toÃ n, khÃ´ng dá»±a vÃ o global by-id
    const summaryEl = document.getElementById("summary");
    const adminTableEl = document.getElementById("adminTable");
    const phucKhaoTableEl = document.getElementById("phucKhaoTable");
    const searchInputEl = document.getElementById("searchInput");
    const filterLopEl = document.getElementById("filterLop");
    const filterStatusEl = document.getElementById("filterStatus");
    let rawData = [];

    // Chuyá»ƒn tab
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById("section-dangky").classList.add("hidden");
      document.getElementById("section-phuckhao").classList.add("hidden");
      if (tab === "dangky") {
        document.querySelector(".tab:nth-child(1)").classList.add("active");
        document.getElementById("section-dangky").classList.remove("hidden");
      } else {
        document.querySelector(".tab:nth-child(2)").classList.add("active");
        document.getElementById("section-phuckhao").classList.remove("hidden");
      }
    }

    // ====== ÄÄƒng kÃ½ báº£n cá»©ng ======
    function fetchAndRenderData() {
  fetch("/api/danh-sach")
    .then(res => res.json())
    .then(data => {
      rawData = Array.isArray(data) ? data : [];
      renderTable(rawData);
      updateFilters(rawData);
    })
    .catch(() => {
      adminTableEl.innerHTML = "<p>Lá»—i táº£i dá»¯ liá»‡u</p>";
      summaryEl.textContent = "Tá»•ng: 0";
    });
}

function updateFilters(data) {
  const lopSet = new Set(data.map(r => r.lop).filter(Boolean));
  filterLopEl.innerHTML = '<option value="">-- Lá»c theo lá»›p --</option>';
  [...lopSet].sort().forEach(lop => {
    const opt = document.createElement("option");
    opt.value = lop; opt.textContent = lop;
    filterLopEl.appendChild(opt);
  });
}

function renderTable(data) {
  if (!data.length) {
    adminTableEl.innerHTML = "<p>KhÃ´ng cÃ³ dá»¯ liá»‡u.</p>";
    summaryEl.textContent = "Tá»•ng: 0";
    return;
  }
  const count = data.reduce((acc, d) => {
    acc[d.status] = (acc[d.status] || 0) + 1; return acc;
  }, {});
  summaryEl.innerHTML =
    `Tá»•ng: ${data.length} | â³ ${count.dang_xu_ly||0} - ğŸ–‹ ${count.cho_ky||0} - âœ… ${count.da_ky||0} - ğŸšš ${count.dang_van_chuyen||0} - ğŸ“¦ ${count.san_sang_nhan||0} - ğŸ“¬ ${count.da_nhan||0}`;

  let html = `<table><thead><tr>
    <th>STT</th><th>Há» tÃªn</th><th>MSSV</th><th>Lá»›p</th><th>Tráº¡ng thÃ¡i</th>
  </tr></thead><tbody>`;
  data.forEach((r,i)=> {
    html += `<tr>
      <td>${i+1}</td><td>${r.fullName||""}</td><td>${r.msv||""}</td>
      <td>${r.lop||""}</td><td>${r.status||""}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  adminTableEl.innerHTML = html;
}

function exportToExcel() {
  if (!rawData.length) { showToast("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t", "error"); return; }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rawData.map(r => ({
    "Há» tÃªn": r.fullName || "", "MSSV": r.msv || "", "Lá»›p": r.lop || "",
    "Tráº¡ng thÃ¡i": r.status || ""
  })));
  XLSX.utils.book_append_sheet(wb, ws, "Danh sÃ¡ch");
  XLSX.writeFile(wb, "dang_ky_toeic.xlsx");
}
    // ====== PhÃºc kháº£o ======
    function fetchPhucKhao() {
      fetch("/api/admin/phuc-khao")
        .then(res => res.json())
        .then(data => {
          if (!data.success) { phucKhaoTable.innerHTML = "<p>Lá»—i táº£i dá»¯ liá»‡u</p>"; return; }
          renderPhucKhao(data.data);
        });
    }
    function renderPhucKhao(list) {
  if (!list.length) { phucKhaoTableEl.innerHTML = "<p>ChÆ°a cÃ³ yÃªu cáº§u phÃºc kháº£o</p>"; return; }
  let html = `<table><thead><tr>
      <th>STT</th><th>SBD</th><th>MSSV</th><th>Email</th><th>Thá»i gian</th><th>Tráº¡ng thÃ¡i</th>
    </tr></thead><tbody>`;
  list.forEach((r,i)=> {
    html += `<tr>
      <td>${i+1}</td>
      <td>${r.sbd||""}</td>
      <td>${r.msv||""}</td>
      <td>${r.email||""}</td>
      <td>${r.time ? dayjs(r.time).format("HH:mm DD/MM/YYYY") : ""}</td>
      <td>
        <select onchange="capNhatTrangThaiPhucKhao('${r._id}', this.value)">
          <option value="dang_xu_ly" ${r.status==="dang_xu_ly"?"selected":""}>â³ Äang xá»­ lÃ½</option>
          <option value="da_xem" ${r.status==="da_xem"?"selected":""}>ğŸ‘€ ÄÃ£ xem</option>
          <option value="da_giai_quyet" ${r.status==="da_giai_quyet"?"selected":""}>âœ… ÄÃ£ giáº£i quyáº¿t</option>
        </select>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  phucKhaoTableEl.innerHTML = html;
}

    function capNhatTrangThaiPhucKhao(id, status) {
      fetch(`/api/admin/phuc-khao/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      })
      .then(res=>res.json())
      .then(data=>{
        showToast(data.message || "ÄÃ£ cáº­p nháº­t tráº¡ng thÃ¡i phÃºc kháº£o");
        fetchPhucKhao();
      });
    }

    function showToast(msg,type="success"){const toast=document.createElement("div");toast.className=`toast ${type==="error"?"error":""}`;toast.textContent=msg;document.getElementById("toast-container").appendChild(toast);setTimeout(()=>toast.classList.add("exit"),3000);setTimeout(()=>toast.remove(),3500);}

    // Load ban Ä‘áº§u
    fetchAndRenderData();
    fetchPhucKhao();
    setInterval(fetchAndRenderData, 10000);
    setInterval(fetchPhucKhao, 10000);
  </script>
</body>
</html>
