<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý TOEIC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url("images/POSTER.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      backdrop-filter: blur(3px);
      z-index: 0;
    }
    .tabs { display: flex; background: #007bff; z-index: 9999; }
    .tab { flex: 1; padding: 14px; text-align: center; color: white; cursor: pointer; font-weight: bold; }
    .tab.active { background: #0056b3; }
    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    h2 { text-align: center; font-size: 28px; margin-bottom: 10px; }
    .search-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-bottom: 20px; }
    input[type="text"], select {
      padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; min-width: 250px;
    }
    #summary { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
    table { width: 100%; border-collapse: collapse; font-size: 16px; }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .actions { text-align: center; margin-top: 24px; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .btn { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn:hover { background: #218838; }
    .hidden { display: none; }
    #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; }
    .toast {
      background-color: #28a745; color: white; padding: 14px 20px; margin-top: 12px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 16px; min-width: 220px;
      animation: slideInRight 0.5s ease forwards; position: relative; overflow: hidden;
    }
    .toast.exit { animation: slideOutRight 0.5s ease forwards; }
    .toast.error { background-color: #dc3545; }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>
</head>
<body>
  <div id="toast-container"></div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dangky')">📋 Đăng ký bản cứng</div>
    <div class="tab" onclick="switchTab('phuckhao')">📩 Phúc khảo</div>
  </div>

  <div class="container">
    <!-- Section Đăng ký -->
    <div id="section-dangky">
      <h2>DANH SÁCH THÍ SINH ĐĂNG KÝ BẢN CỨNG</h2>
      <div id="summary">Đang tải...</div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Tìm theo họ tên / MSSV / lớp..." />
        <select id="filterLop"><option value="">-- Lọc theo lớp --</option></select>
        <select id="filterStatus">
          <option value="">-- Lọc trạng thái --</option>
          <option value="dang_xu_ly">⏳ Đang xử lý</option>
          <option value="cho_ky">🖋 Chờ ký</option>
          <option value="da_ky">✅ Đã ký</option>
          <option value="dang_van_chuyen">🚚 Đang vận chuyển</option>
          <option value="san_sang_nhan">📦 Sẵn sàng nhận</option>
          <option value="da_nhan">📬 Đã nhận</option>
        </select>
      </div>
      <div id="adminTable">Loading...</div>
      <div class="actions">
        <button class="btn" onclick="exportToExcel()">📤 Xuất Excel</button>
        <button class="btn" onclick="window.print()">🖨️ In danh sách</button>
      </div>
    </div>

    <!-- Section Phúc khảo -->
    <div id="section-phuckhao" class="hidden">
      <h2>DANH SÁCH YÊU CẦU PHÚC KHẢO</h2>
      <div id="phucKhaoTable">Loading...</div>
    </div>
  </div>

  <script>
    dayjs.extend(dayjs_plugin_relativeTime);
    // Tham chiếu DOM an toàn, không dựa vào global by-id
    const summaryEl = document.getElementById("summary");
    const adminTableEl = document.getElementById("adminTable");
    const phucKhaoTableEl = document.getElementById("phucKhaoTable");
    const searchInputEl = document.getElementById("searchInput");
    const filterLopEl = document.getElementById("filterLop");
    const filterStatusEl = document.getElementById("filterStatus");
    let rawData = [];

    // Chuyển tab
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById("section-dangky").classList.add("hidden");
      document.getElementById("section-phuckhao").classList.add("hidden");
      if (tab === "dangky") {
        document.querySelector(".tab:nth-child(1)").classList.add("active");
        document.getElementById("section-dangky").classList.remove("hidden");
      } else {
        document.querySelector(".tab:nth-child(2)").classList.add("active");
        document.getElementById("section-phuckhao").classList.remove("hidden");
      }
    }

    // ====== Đăng ký bản cứng ======
    function fetchAndRenderData() {
  fetch("/api/danh-sach")
    .then(res => res.json())
    .then(data => {
      rawData = Array.isArray(data) ? data : [];
      renderTable(rawData);
      updateFilters(rawData);
    })
    .catch(() => {
      adminTableEl.innerHTML = "<p>Lỗi tải dữ liệu</p>";
      summaryEl.textContent = "Tổng: 0";
    });
}

function updateFilters(data) {
  const lopSet = new Set(data.map(r => r.lop).filter(Boolean));
  filterLopEl.innerHTML = '<option value="">-- Lọc theo lớp --</option>';
  [...lopSet].sort().forEach(lop => {
    const opt = document.createElement("option");
    opt.value = lop; opt.textContent = lop;
    filterLopEl.appendChild(opt);
  });
}

function renderTable(data) {
  if (!data.length) {
    adminTableEl.innerHTML = "<p>Không có dữ liệu.</p>";
    summaryEl.textContent = "Tổng: 0";
    return;
  }
  const count = data.reduce((acc, d) => {
    acc[d.status] = (acc[d.status] || 0) + 1; return acc;
  }, {});
  summaryEl.innerHTML =
    `Tổng: ${data.length} | ⏳ ${count.dang_xu_ly||0} - 🖋 ${count.cho_ky||0} - ✅ ${count.da_ky||0} - 🚚 ${count.dang_van_chuyen||0} - 📦 ${count.san_sang_nhan||0} - 📬 ${count.da_nhan||0}`;

  let html = `<table><thead><tr>
    <th>STT</th><th>Họ tên</th><th>MSSV</th><th>Lớp</th><th>Trạng thái</th>
  </tr></thead><tbody>`;
  data.forEach((r,i)=> {
    html += `<tr>
      <td>${i+1}</td><td>${r.fullName||""}</td><td>${r.msv||""}</td>
      <td>${r.lop||""}</td><td>${r.status||""}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  adminTableEl.innerHTML = html;
}

function exportToExcel() {
  if (!rawData.length) { showToast("Không có dữ liệu để xuất", "error"); return; }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rawData.map(r => ({
    "Họ tên": r.fullName || "", "MSSV": r.msv || "", "Lớp": r.lop || "",
    "Trạng thái": r.status || ""
  })));
  XLSX.utils.book_append_sheet(wb, ws, "Danh sách");
  XLSX.writeFile(wb, "dang_ky_toeic.xlsx");
}
    // ====== Phúc khảo ======
    function fetchPhucKhao() {
      fetch("/api/admin/phuc-khao")
        .then(res => res.json())
        .then(data => {
          if (!data.success) { phucKhaoTable.innerHTML = "<p>Lỗi tải dữ liệu</p>"; return; }
          renderPhucKhao(data.data);
        });
    }
    function renderPhucKhao(list) {
  if (!list.length) { phucKhaoTableEl.innerHTML = "<p>Chưa có yêu cầu phúc khảo</p>"; return; }
  let html = `<table><thead><tr>
      <th>STT</th><th>SBD</th><th>MSSV</th><th>Email</th><th>Thời gian</th><th>Trạng thái</th>
    </tr></thead><tbody>`;
  list.forEach((r,i)=> {
    html += `<tr>
      <td>${i+1}</td>
      <td>${r.sbd||""}</td>
      <td>${r.msv||""}</td>
      <td>${r.email||""}</td>
      <td>${r.time ? dayjs(r.time).format("HH:mm DD/MM/YYYY") : ""}</td>
      <td>
        <select onchange="capNhatTrangThaiPhucKhao('${r._id}', this.value)">
          <option value="dang_xu_ly" ${r.status==="dang_xu_ly"?"selected":""}>⏳ Đang xử lý</option>
          <option value="da_xem" ${r.status==="da_xem"?"selected":""}>👀 Đã xem</option>
          <option value="da_giai_quyet" ${r.status==="da_giai_quyet"?"selected":""}>✅ Đã giải quyết</option>
        </select>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  phucKhaoTableEl.innerHTML = html;
}

    function capNhatTrangThaiPhucKhao(id, status) {
      fetch(`/api/admin/phuc-khao/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      })
      .then(res=>res.json())
      .then(data=>{
        showToast(data.message || "Đã cập nhật trạng thái phúc khảo");
        fetchPhucKhao();
      });
    }

    function showToast(msg,type="success"){const toast=document.createElement("div");toast.className=`toast ${type==="error"?"error":""}`;toast.textContent=msg;document.getElementById("toast-container").appendChild(toast);setTimeout(()=>toast.classList.add("exit"),3000);setTimeout(()=>toast.remove(),3500);}

    // Load ban đầu
    fetchAndRenderData();
    fetchPhucKhao();
    setInterval(fetchAndRenderData, 10000);
    setInterval(fetchPhucKhao, 10000);
  </script>
</body>
</html>
